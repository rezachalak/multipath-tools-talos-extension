variant: alpine
name: multipath-tools
shell: /bin/bash
dependencies:
  - stage: base
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/lvm2:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/systemd-udevd:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libjson-c:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/liburcu:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libcap:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libaio:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/util-linux:{{ .BUILD_ARG_PKGS }}"
steps:
  - sources:
      - url: https://github.com/opensvc/multipath-tools/archive/refs/tags/{{ .MULTIPATH_TOOLS_VERSION }}.tar.gz
        destination: multipath-tools.tar.gz
        sha256: {{ .MULTIPATH_TOOLS_SHA256 }}
        sha512: {{ .MULTIPATH_TOOLS_SHA512 }}
    env:
      PKG_CONFIG_PATH: /usr/lib/pkgconfig
      prefix: /usr/local/lib/containers/multipathd
      LIB: /usr/lib
    prepare:
      - |
        sed -i 's#$VERSION#{{ .VERSION }}#' /pkg/manifest.yaml

      - |
        tar -xzf multipath-tools.tar.gz --strip-components=1

      # This removes a dependency on libgcc
      - |
        patch -p1 < /pkg/patches/disable-exception-handling.patch
    build:
      - |
        container_root=${prefix}
        mkdir -p "${container_root}"
        make -j $(nproc) SYSTEMD=""
    install:
      - |
        make prefix=/rootfs/usr/local DESTDIR=/rootfs install
        cp /rootfs/usr/local/sbin/multipathd /rootfs${prefix}/
      - |
        mkdir -p /rootfs/usr/local/etc/containers
        cp /pkg/multipathd.yaml /rootfs/usr/local/etc/containers/
      - |

      # This file wants to load kernel module `dm-multipath`.
      # Talos users should load kernel modules via MachineConfig instead.
      - |
        rm /rootfs/usr/lib/modules-load.d/multipath.conf
        rmdir /rootfs/usr/lib/modules-load.d

      # This file tries to create a tmpfs mount at `/var/run/multipath`.
      # TODO: Probably should do this in the extension service or elsewhere.
      - |
        rm /rootfs/usr/lib/tmpfiles.d/multipath.conf
        rmdir /rootfs/usr/lib/tmpfiles.d

      # TODO: Not sure what to do with this yet.
      - |
        rm /rootfs/usr/lib/udev/kpartx_id
    test:
      - |
        mkdir -p /extensions-validator-rootfs
        cp -r /rootfs/ /extensions-validator-rootfs/rootfs
        cp /pkg/manifest.yaml /extensions-validator-rootfs/manifest.yaml
        /extensions-validator validate --rootfs=/extensions-validator-rootfs --pkg-name="${PKG_NAME}"
finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
